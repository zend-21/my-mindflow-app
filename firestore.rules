rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // í—¬í¼ í•¨ìˆ˜ë“¤
    // ========================================

    // ì‚¬ìš©ì ì¸ì¦ í™•ì¸
    function isSignedIn() {
      return request.auth != null;
    }

    // ì‚¬ìš©ì ID ì†Œìœ ê¶Œ í™•ì¸
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ========================================
    // ê¸°ì¡´ ë ˆìŠ¤í† ë‘/ë¦¬ë·° - ê³µê°œ ì½ê¸°
    // ========================================
    match /restaurants/{restaurantId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    match /reviews/{reviewId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    match /userProfiles/{userId} {
      allow read: if true;
      allow write: if isOwner(userId);
    }

    // ========================================
    // ì‚¬ìš©ì (Users) ì»¬ë ‰ì…˜
    // ========================================
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(userId);
      allow update, delete: if isOwner(userId);

      // ğŸ†• ì¹œêµ¬ ì„œë¸Œì»¬ë ‰ì…˜ - ë³¸ì¸ë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      match /friends/{friendId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
    }

    // ========================================
    // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ (Workspaces)
    // ========================================
    match /workspaces/{workspaceId} {
      // ìƒì„±: ë¡œê·¸ì¸ + ì†Œìœ ì í™•ì¸
      allow create: if isSignedIn() &&
        request.resource.data.ownerId == request.auth.uid;

      // ì½ê¸°: ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì (ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì½”ë“œë¡œ ì ‘ê·¼)
      allow read: if isSignedIn();

      // ìˆ˜ì •: ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì†Œìœ ìë§Œ
      allow update: if isSignedIn() &&
        request.auth.uid == resource.data.ownerId;

      // ì‚­ì œ: ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì†Œìœ ìë§Œ
      allow delete: if isSignedIn() &&
        request.auth.uid == resource.data.ownerId;
    }

    // ========================================
    // í˜‘ì—…ë°© (Collaboration Rooms)
    // ========================================
    match /collaborationRooms/{roomId} {
      // ìƒì„±: ë¡œê·¸ì¸ + ì†Œìœ ì í™•ì¸ + ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ID í•„ìˆ˜
      allow create: if isSignedIn() &&
        request.resource.data.ownerId == request.auth.uid &&
        request.resource.data.workspaceId != null;

      // ì½ê¸°: ì°¸ì—¬ìë§Œ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°°ì—´ ê²€ì¦)
      allow read: if isSignedIn();

      // ìˆ˜ì •: ë°©ì¥ ë˜ëŠ” í¸ì§‘ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.ownerId ||
        resource.data.permissions.allCanEdit == true ||
        request.auth.uid in resource.data.permissions.editableUsers
      );

      // ì‚­ì œ: ë°©ì¥ë§Œ
      allow delete: if isSignedIn() &&
        request.auth.uid == resource.data.ownerId;
    }

    // ========================================
    // ì±„íŒ… ë©”ì‹œì§€ (Chat Messages)
    // ========================================
    match /chatMessages/{messageId} {
      // ìƒì„±: ë¡œê·¸ì¸ + ë³¸ì¸ í™•ì¸
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.type in ['text', 'system', 'edit'];

      // ì½ê¸°: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
      allow read: if isSignedIn();

      // ìˆ˜ì •: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (ì½ìŒ ì²˜ë¦¬ìš©)
      allow update: if isSignedIn();

      // ì‚­ì œ: ì‘ì„±ìë§Œ
      allow delete: if isSignedIn() &&
        request.auth.uid == resource.data.userId;
    }

    // ========================================
    // ë°© ì´ˆëŒ€ (Room Invitations)
    // ========================================
    match /roomInvitations/{invitationId} {
      // ìƒì„±: ì´ˆëŒ€í•˜ëŠ” ì‚¬ëŒë§Œ
      allow create: if isSignedIn() &&
        request.resource.data.inviterId == request.auth.uid;

      // ì½ê¸°: ì´ˆëŒ€í•œ ì‚¬ëŒ ë˜ëŠ” ì´ˆëŒ€ë°›ì€ ì‚¬ëŒ
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.inviterId ||
        request.auth.uid == resource.data.inviteeId
      );

      // ìˆ˜ì •: ì´ˆëŒ€ë°›ì€ ì‚¬ëŒë§Œ (ìˆ˜ë½/ê±°ì ˆ)
      allow update: if isSignedIn() &&
        request.auth.uid == resource.data.inviteeId &&
        request.resource.data.status in ['accepted', 'rejected'];

      // ì‚­ì œ: ì´ˆëŒ€í•œ ì‚¬ëŒë§Œ
      allow delete: if isSignedIn() &&
        request.auth.uid == resource.data.inviterId;
    }

    // ========================================
    // ë©”ëª¨ ê³µìœ  (Shared Memos)
    // ========================================
    match /sharedMemos/{memoId} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
      allow create: if isSignedIn();

      // ì½ê¸°: ì†Œìœ ì ë˜ëŠ” ê³µìœ ë°›ì€ ì‚¬ëŒ (í´ë¼ì´ì–¸íŠ¸ ê²€ì¦)
      allow read: if isSignedIn();

      // ìˆ˜ì •/ì‚­ì œ: ì†Œìœ ìë§Œ
      allow update, delete: if isSignedIn() &&
        request.auth.uid == resource.data.ownerId;
    }

    // ========================================
    // ì¹œêµ¬ ê´€ê³„ (Friendships)
    // ========================================
    match /friendships/{friendshipId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ========================================
    // ì¹œêµ¬ ìš”ì²­ (Friend Requests)
    // ========================================
    match /friendRequests/{requestId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ========================================
    // ê³µìœ  ë…¸íŠ¸ (Shared Notes)
    // ========================================
    match /sharedNotes/{noteId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn() &&
        resource.data.ownerId == request.auth.uid;
    }

    // ========================================
    // ìˆ˜ì • ì œì•ˆ (Edit Suggestions)
    // ========================================
    match /editSuggestions/{suggestionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ========================================
    // ì•Œë¦¼ (Notifications)
    // ========================================
    match /notifications/{notificationId} {
      allow read: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
      allow create: if isSignedIn();
      allow update: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
    }

    // ========================================
    // íƒ€ì´í•‘ ìƒíƒœ (Typing Status)
    // ========================================
    match /typingStatus/{statusId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
    }

    // ========================================
    // 1:1 ëŒ€í™”ë°© (Direct Messages)
    // ========================================
    match /directMessages/{roomId} {
      // í…ŒìŠ¤íŠ¸ìš© ë‹¨ìˆœ ê·œì¹™: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ
      allow create: if isSignedIn();
      allow read: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();

      // ë©”ì‹œì§€ ì„œë¸Œì»¬ë ‰ì…˜
      match /messages/{messageId} {
        allow create: if isSignedIn();
        allow read: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }

    // ========================================
    // ê·¸ë£¹ ì±„íŒ…ë°© (Group Chats)
    // ========================================
    match /groupChats/{groupId} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
      allow create: if isSignedIn();
      // ì½ê¸°: ë©¤ë²„ë§Œ
      allow read: if isSignedIn();
      // ìˆ˜ì •: ë©¤ë²„ë§Œ
      allow update: if isSignedIn();
      // ì‚­ì œ: ìƒì„±ìë§Œ
      allow delete: if isSignedIn();

      // ë©”ì‹œì§€ ì„œë¸Œì»¬ë ‰ì…˜
      match /messages/{messageId} {
        allow create: if isSignedIn();
        allow read: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }

    // ========================================
    // ë‹‰ë„¤ì„ (Nicknames)
    // ========================================
    match /nicknames/{userId} {
      // ì½ê¸°: ëª¨ë“  ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬ìš©)
      allow read: if isSignedIn();
      // ìƒì„±/ìˆ˜ì •: ë³¸ì¸ë§Œ (userIdê°€ ë¬¸ì„œ IDì™€ ì¼ì¹˜)
      allow create, update: if isSignedIn() &&
        request.auth.uid == userId &&
        request.resource.data.userId == userId;
      // ì‚­ì œ: ë³¸ì¸ë§Œ
      allow delete: if isSignedIn() &&
        request.auth.uid == userId;
    }

    // ========================================
    // ë³¸ì¸ì¸ì¦ (Verifications)
    // ========================================
    match /verifications/{userId} {
      // ì½ê¸°: ëª¨ë“  ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (ì¸ì¦ ë±ƒì§€ í‘œì‹œìš©)
      allow read: if isSignedIn();
      // ìƒì„±/ìˆ˜ì •: ë³¸ì¸ë§Œ (userIdê°€ ë¬¸ì„œ IDì™€ ì¼ì¹˜)
      allow create, update: if isSignedIn() &&
        request.auth.uid == userId &&
        request.resource.data.userId == userId;
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ (ì¶”í›„ êµ¬í˜„)
      allow delete: if false;
    }

    // ========================================
    // ë©”ëª¨ (Memos)
    // ========================================
    match /memos/{memoId} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (ë³¸ì¸ì˜ ë©”ëª¨ë§Œ)
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;

      // ì½ê¸°: ë³¸ì¸ì˜ ë©”ëª¨ë§Œ
      allow read: if isSignedIn() &&
        resource.data.userId == request.auth.uid;

      // ìˆ˜ì •: ë³¸ì¸ì˜ ë©”ëª¨ë§Œ
      allow update: if isSignedIn() &&
        resource.data.userId == request.auth.uid;

      // ì‚­ì œ: ë³¸ì¸ì˜ ë©”ëª¨ë§Œ
      allow delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
    }
  }
}
