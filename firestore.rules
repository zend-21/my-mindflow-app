rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // í—¬í¼ í•¨ìˆ˜ë“¤
    // ========================================

    // ì‚¬ìš©ì ì¸ì¦ í™•ì¸
    function isSignedIn() {
      return request.auth != null;
    }

    // ì‚¬ìš©ì ID ì†Œìœ ê¶Œ í™•ì¸
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // í˜‘ì—…ë°© ì°¸ì—¬ì í™•ì¸ (í—¬í¼ í•¨ìˆ˜)
    function isParticipant(roomData) {
      return request.auth.uid in roomData.participants.map('userId', p, p.userId);
    }

    // í¸ì§‘ ê¶Œí•œ í™•ì¸ (í—¬í¼ í•¨ìˆ˜)
    function hasEditPermission(roomData) {
      return roomData.permissions.allCanEdit == true ||
             request.auth.uid in roomData.permissions.editableUsers;
    }

    // ========================================
    // ê¸°ì¡´ ë ˆìŠ¤í† ë‘/ë¦¬ë·° - ê³µê°œ ì½ê¸°
    // ========================================
    match /restaurants/{restaurantId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    match /reviews/{reviewId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    match /userProfiles/{userId} {
      allow read: if true;
      allow write: if isOwner(userId);
    }

    // ========================================
    // ì‚¬ìš©ì (Users) ì»¬ë ‰ì…˜
    // ========================================
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(userId);
      allow update, delete: if isOwner(userId);

      // ğŸ†• ì¹œêµ¬ ì„œë¸Œì»¬ë ‰ì…˜ - ë³¸ì¸ë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      match /friends/{friendId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
    }

    // ========================================
    // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ (Workspaces)
    // ========================================
    match /workspaces/{workspaceId} {
      // ìƒì„±: ë¡œê·¸ì¸ + ì†Œìœ ì í™•ì¸
      allow create: if isSignedIn() &&
        request.resource.data.ownerId == request.auth.uid;

      // ì½ê¸°: ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì (ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì½”ë“œë¡œ ì ‘ê·¼)
      allow read: if isSignedIn();

      // ìˆ˜ì •: ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì†Œìœ ìë§Œ
      allow update: if isSignedIn() &&
        request.auth.uid == resource.data.ownerId;

      // ì‚­ì œ: ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì†Œìœ ìë§Œ
      allow delete: if isSignedIn() &&
        request.auth.uid == resource.data.ownerId;
    }

    // ========================================
    // í˜‘ì—…ë°© (Collaboration Rooms)
    // ========================================
    match /collaborationRooms/{roomId} {
      // ìƒì„±: ë¡œê·¸ì¸ + ì†Œìœ ì í™•ì¸ + ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ID í•„ìˆ˜
      allow create: if isSignedIn() &&
        request.resource.data.ownerId == request.auth.uid &&
        request.resource.data.workspaceId != null;

      // ì½ê¸°: ì°¸ì—¬ìë§Œ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°°ì—´ ê²€ì¦)
      allow read: if isSignedIn();

      // ìˆ˜ì •: ë°©ì¥ ë˜ëŠ” í¸ì§‘ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.ownerId ||
        resource.data.permissions.allCanEdit == true ||
        request.auth.uid in resource.data.permissions.editableUsers
      );

      // ì‚­ì œ: ë°©ì¥ë§Œ
      allow delete: if isSignedIn() &&
        request.auth.uid == resource.data.ownerId;
    }

    // ========================================
    // ì±„íŒ… ë©”ì‹œì§€ (Chat Messages)
    // ========================================
    match /chatMessages/{messageId} {
      // ìƒì„±: ë¡œê·¸ì¸ + ë³¸ì¸ í™•ì¸
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.type in ['text', 'system', 'edit'];

      // ì½ê¸°: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
      allow read: if isSignedIn();

      // ìˆ˜ì •: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (ì½ìŒ ì²˜ë¦¬ìš©)
      allow update: if isSignedIn();

      // ì‚­ì œ: ì‘ì„±ìë§Œ
      allow delete: if isSignedIn() &&
        request.auth.uid == resource.data.userId;
    }

    // ========================================
    // ë°© ì´ˆëŒ€ (Room Invitations)
    // ========================================
    match /roomInvitations/{invitationId} {
      // ìƒì„±: ì´ˆëŒ€í•˜ëŠ” ì‚¬ëŒë§Œ
      allow create: if isSignedIn() &&
        request.resource.data.inviterId == request.auth.uid;

      // ì½ê¸°: ì´ˆëŒ€í•œ ì‚¬ëŒ ë˜ëŠ” ì´ˆëŒ€ë°›ì€ ì‚¬ëŒ
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.inviterId ||
        request.auth.uid == resource.data.inviteeId
      );

      // ìˆ˜ì •: ì´ˆëŒ€ë°›ì€ ì‚¬ëŒë§Œ (ìˆ˜ë½/ê±°ì ˆ)
      allow update: if isSignedIn() &&
        request.auth.uid == resource.data.inviteeId &&
        request.resource.data.status in ['accepted', 'rejected'];

      // ì‚­ì œ: ì´ˆëŒ€í•œ ì‚¬ëŒë§Œ
      allow delete: if isSignedIn() &&
        request.auth.uid == resource.data.inviterId;
    }

    // ========================================
    // ë©”ëª¨ ê³µìœ  (Shared Memos)
    // ========================================
    match /sharedMemos/{memoId} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
      allow create: if isSignedIn();

      // ì½ê¸°: ì†Œìœ ì ë˜ëŠ” ê³µìœ ë°›ì€ ì‚¬ëŒ (í´ë¼ì´ì–¸íŠ¸ ê²€ì¦)
      allow read: if isSignedIn();

      // ìˆ˜ì •/ì‚­ì œ: ì†Œìœ ìë§Œ
      allow update, delete: if isSignedIn() &&
        request.auth.uid == resource.data.ownerId;
    }

    // ========================================
    // ì¹œêµ¬ ê´€ê³„ (Friendships)
    // ========================================
    match /friendships/{friendshipId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ========================================
    // ì¹œêµ¬ ìš”ì²­ (Friend Requests)
    // ========================================
    match /friendRequests/{requestId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ========================================
    // ê³µìœ  ë…¸íŠ¸ (Shared Notes)
    // ========================================
    match /sharedNotes/{noteId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn() &&
        resource.data.ownerId == request.auth.uid;
    }

    // ========================================
    // ìˆ˜ì • ì œì•ˆ (Edit Suggestions)
    // ========================================
    match /editSuggestions/{suggestionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ========================================
    // ì•Œë¦¼ (Notifications)
    // ========================================
    match /notifications/{notificationId} {
      allow read: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
      allow create: if isSignedIn();
      allow update: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
    }

    // ========================================
    // íƒ€ì´í•‘ ìƒíƒœ (Typing Status)
    // ========================================
    match /typingStatus/{statusId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
    }

    // ========================================
    // 1:1 ëŒ€í™”ë°© (Direct Messages)
    // ========================================
    match /directMessages/{roomId} {
      // ëŒ€í™”ë°© ìƒì„±: ë¡œê·¸ì¸ + ì°¸ì—¬ìì— ë³¸ì¸ í¬í•¨
      allow create: if isSignedIn() &&
        request.auth.uid in request.resource.data.participants;

      // ëŒ€í™”ë°© ì½ê¸°: ì°¸ì—¬ìë§Œ
      allow read: if isSignedIn() &&
        request.auth.uid in resource.data.participants;

      // ëŒ€í™”ë°© ìˆ˜ì •: ì°¸ì—¬ìë§Œ (ì½ìŒ í‘œì‹œ, ìˆ¨ê¹€ ë“±)
      allow update: if isSignedIn() &&
        request.auth.uid in resource.data.participants;

      // ëŒ€í™”ë°© ì‚­ì œ: ì°¸ì—¬ìë§Œ
      allow delete: if isSignedIn() &&
        request.auth.uid in resource.data.participants;

      // ë©”ì‹œì§€ ì„œë¸Œì»¬ë ‰ì…˜
      match /messages/{messageId} {
        // ë©”ì‹œì§€ ìƒì„±: ëŒ€í™”ë°© ì°¸ì—¬ìë§Œ
        allow create: if isSignedIn() &&
          request.auth.uid in get(/databases/$(database)/documents/directMessages/$(roomId)).data.participants &&
          request.resource.data.senderId == request.auth.uid;

        // ë©”ì‹œì§€ ì½ê¸°: ëŒ€í™”ë°© ì°¸ì—¬ìë§Œ
        allow read: if isSignedIn() &&
          request.auth.uid in get(/databases/$(database)/documents/directMessages/$(roomId)).data.participants;

        // ë©”ì‹œì§€ ìˆ˜ì •: ì‘ì„±ìë§Œ
        allow update: if isSignedIn() &&
          request.auth.uid == resource.data.senderId;

        // ë©”ì‹œì§€ ì‚­ì œ: ì‘ì„±ìë§Œ
        allow delete: if isSignedIn() &&
          request.auth.uid == resource.data.senderId;
      }
    }
  }
}
