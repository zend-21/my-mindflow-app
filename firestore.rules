rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // í—¬í¼ í•¨ìˆ˜ë“¤
    // ========================================

    // ì‚¬ìš©ì ì¸ì¦ í™•ì¸
    function isSignedIn() {
      return request.auth != null;
    }

    // ì‚¬ìš©ì ID ì†Œìœ ê¶Œ í™•ì¸
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ê´€ë¦¬ì ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    function getAdminConfig() {
      return get(/databases/$(database)/documents/systemConfig/adminSettings).data;
    }

    // ê´€ë¦¬ì í™•ì¸ (ìµœê³  ê´€ë¦¬ì ë˜ëŠ” ë¶€ê´€ë¦¬ì)
    function isAdmin() {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/systemConfig/adminSettings) &&
        (request.auth.uid == getAdminConfig().superAdmin ||
         request.auth.uid in getAdminConfig().subAdmins.keys());
    }

    // íŠ¹ì • ê¶Œí•œ í™•ì¸ (ë¶€ê´€ë¦¬ììš©)
    function hasPermission(permission) {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/systemConfig/adminSettings) &&
        (request.auth.uid == getAdminConfig().superAdmin ||
         (request.auth.uid in getAdminConfig().subAdmins.keys() &&
          permission in getAdminConfig().subAdmins[request.auth.uid].permissions));
    }

    // ========================================
    // ê¸°ì¡´ ë ˆìŠ¤í† ë‘/ë¦¬ë·° - ê³µê°œ ì½ê¸°
    // ========================================
    match /restaurants/{restaurantId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    match /reviews/{reviewId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    match /userProfiles/{userId} {
      allow read: if true;
      allow write: if isOwner(userId);
    }

    // ========================================
    // ì‚¬ìš©ì (Users) ì»¬ë ‰ì…˜
    // ========================================
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(userId);
      allow update, delete: if isOwner(userId);

      // ğŸ†• ì¹œêµ¬ ì„œë¸Œì»¬ë ‰ì…˜
      match /friends/{friendId} {
        // ì½ê¸°: ë³¸ì¸ë§Œ
        allow read: if isSignedIn() && request.auth.uid == userId;

        // ìƒì„±: ë³¸ì¸ì˜ ì¹œêµ¬ ëª©ë¡ì— ì¶”ê°€í•˜ê±°ë‚˜, ë‹¤ë¥¸ ì‚¬ëŒì´ ë‚˜ë¥¼ ì¹œêµ¬ë¡œ ì¶”ê°€í•˜ëŠ” ê²½ìš°
        allow create: if isSignedIn() && (
          // ë‚´ ì¹œêµ¬ ëª©ë¡ì— ì¶”ê°€ (userId == ë‚´ ID)
          request.auth.uid == userId ||
          // ë‹¤ë¥¸ ì‚¬ëŒì´ ë‚˜ë¥¼ ì¹œêµ¬ë¡œ ì¶”ê°€ (friendId == ë‚´ ID, userId == ë‹¤ë¥¸ ì‚¬ëŒ ID)
          request.resource.data.friendId == request.auth.uid
        );

        // ìˆ˜ì •/ì‚­ì œ: ë³¸ì¸ë§Œ
        allow update, delete: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸ†• ì¹œêµ¬ ìš”ì²­ ì„œë¸Œì»¬ë ‰ì…˜
      match /friendRequests/{requestId} {
        // ì½ê¸°: ë³¸ì¸ì˜ ì¹œêµ¬ ìš”ì²­ë§Œ
        allow read: if isSignedIn() && request.auth.uid == userId;

        // ìƒì„±: ë‹¤ë¥¸ ì‚¬ëŒì´ ë‚˜ì—ê²Œ ì¹œêµ¬ ìš”ì²­ì„ ë³´ë‚´ëŠ” ê²½ìš°
        allow create: if isSignedIn();

        // ìˆ˜ì •: ìš”ì²­ì„ ë³´ë‚¸ ì‚¬ëŒ(requestId)ì´ê±°ë‚˜ ë°›ëŠ” ì‚¬ëŒ(userId)
        allow update: if isSignedIn() && (request.auth.uid == userId || request.auth.uid == requestId);

        // ì‚­ì œ: ë³¸ì¸ì˜ ì¹œêµ¬ ìš”ì²­ë§Œ (ìˆ˜ë½/ê±°ë¶€ ì²˜ë¦¬)
        allow delete: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸ†• ì°¨ë‹¨ëœ ì‚¬ìš©ì ì„œë¸Œì»¬ë ‰ì…˜
      match /blockedUsers/{blockedUserId} {
        // ì½ê¸°: ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì (ì´ˆëŒ€ ì‹œ ì°¨ë‹¨ í™•ì¸ìš©)
        allow read: if isSignedIn();

        // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ë³¸ì¸ë§Œ
        allow create, update, delete: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸ†• ì‚­ì œëœ ì¹œêµ¬ ì„œë¸Œì»¬ë ‰ì…˜
      match /deletedFriends/{friendId} {
        // ì½ê¸°: ë³¸ì¸ë§Œ
        allow read: if isSignedIn() && request.auth.uid == userId;

        // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ë³¸ì¸ë§Œ
        allow create, update, delete: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸ†• ì‚¬ìš©ì ì„¤ì • ì„œë¸Œì»¬ë ‰ì…˜
      match /settings/{settingType} {
        // ì½ê¸°: ëª¨ë“  ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (í”„ë¡œí•„ ì‚¬ì§„, ì•„ë°”íƒ€ í‘œì‹œìš©)
        allow read: if isSignedIn();

        // ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ë³¸ì¸ë§Œ
        allow create, update, delete: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸ†• ì•½ê´€ ë™ì˜ ì„œë¸Œì»¬ë ‰ì…˜
      match /agreements/{agreementType} {
        // ì½ê¸°: ë³¸ì¸ë§Œ
        allow read: if isSignedIn() && request.auth.uid == userId;

        // ìƒì„±/ìˆ˜ì •: ë³¸ì¸ë§Œ
        allow create, update: if isSignedIn() && request.auth.uid == userId;

        // ì‚­ì œ: ê¸ˆì§€ (ì•½ê´€ ë™ì˜ ê¸°ë¡ ë³´ì¡´)
        allow delete: if false;
      }

      // ğŸ†• ë¬¸ì˜ ì„œë¸Œì»¬ë ‰ì…˜ (users/{userId}/inquiries)
      match /inquiries/{inquiryId} {
        // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
        allow read: if isSignedIn() && (
          request.auth.uid == userId ||
          isAdmin()
        );

        // ìƒì„±: ë³¸ì¸ë§Œ (ì‚¬ìš©ìê°€ ë¬¸ì˜ ì‘ì„±)
        allow create: if isSignedIn() && request.auth.uid == userId;

        // ìˆ˜ì •: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì (ê´€ë¦¬ìëŠ” ìƒíƒœë§Œ ë³€ê²½ ê°€ëŠ¥)
        allow update: if isSignedIn() && (
          request.auth.uid == userId ||
          isAdmin()
        );

        // ì‚­ì œ: ë³¸ì¸ ë˜ëŠ” delete ê¶Œí•œì´ ìˆëŠ” ê´€ë¦¬ì
        allow delete: if isSignedIn() && (
          request.auth.uid == userId ||
          hasPermission('delete')
        );

        // ë‹µë³€ ì„œë¸Œì»¬ë ‰ì…˜
        match /replies/{replyId} {
          // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
          allow read: if isSignedIn() && (
            request.auth.uid == userId ||
            isAdmin()
          );

          // ìƒì„±: reply ê¶Œí•œì´ ìˆëŠ” ê´€ë¦¬ìë§Œ
          allow create: if hasPermission('reply');

          // ìˆ˜ì •: edit ê¶Œí•œì´ ìˆëŠ” ê´€ë¦¬ìë§Œ
          allow update: if hasPermission('edit');

          // ì‚­ì œ: delete ê¶Œí•œì´ ìˆëŠ” ê´€ë¦¬ìë§Œ
          allow delete: if hasPermission('delete');
        }
      }
    }

    // ========================================
    // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ (Workspaces)
    // ========================================
    match /workspaces/{workspaceId} {
      // ìƒì„±: ë¡œê·¸ì¸ + ì†Œìœ ì í™•ì¸ (userId í•„ë“œ ì‚¬ìš©)
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;

      // ì½ê¸°: ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì (ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì½”ë“œë¡œ ì ‘ê·¼)
      allow read: if isSignedIn();

      // ìˆ˜ì •: ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì†Œìœ ìë§Œ (userId í•„ë“œ ì‚¬ìš©)
      allow update: if isSignedIn() &&
        request.auth.uid == resource.data.userId;

      // ì‚­ì œ: ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì†Œìœ ìë§Œ (userId í•„ë“œ ì‚¬ìš©)
      allow delete: if isSignedIn() &&
        request.auth.uid == resource.data.userId;
    }

    // ========================================
    // ë©”ëª¨ ê³µìœ  (Shared Memos)
    // ========================================
    match /sharedMemos/{memoId} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
      allow create: if isSignedIn();

      // ì½ê¸°: ì†Œìœ ì ë˜ëŠ” ê³µìœ ë°›ì€ ì‚¬ëŒ (í´ë¼ì´ì–¸íŠ¸ ê²€ì¦)
      allow read: if isSignedIn();

      // ìˆ˜ì •/ì‚­ì œ: ì†Œìœ ìë§Œ
      allow update, delete: if isSignedIn() &&
        request.auth.uid == resource.data.ownerId;
    }

    // ========================================
    // ì¹œêµ¬ ê´€ê³„ (Friendships)
    // ========================================
    match /friendships/{friendshipId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ========================================
    // ì¹œêµ¬ ìš”ì²­ (Friend Requests)
    // ========================================
    match /friendRequests/{requestId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ========================================
    // ê³µìœ  ë…¸íŠ¸ (Shared Notes)
    // ========================================
    match /sharedNotes/{noteId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn() &&
        resource.data.ownerId == request.auth.uid;
    }

    // ========================================
    // ìˆ˜ì • ì œì•ˆ (Edit Suggestions)
    // ========================================
    match /editSuggestions/{suggestionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ========================================
    // ì•Œë¦¼ (Notifications)
    // ========================================
    match /notifications/{notificationId} {
      allow read: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
      allow create: if isSignedIn();
      allow update: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
    }

    // ========================================
    // íƒ€ì´í•‘ ìƒíƒœ (Typing Status)
    // ========================================
    match /typingStatus/{statusId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
    }

    // ========================================
    // 1:1 ëŒ€í™”ë°© (Direct Messages)
    // ========================================
    match /directMessages/{roomId} {
      // í…ŒìŠ¤íŠ¸ìš© ë‹¨ìˆœ ê·œì¹™: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ
      allow create: if isSignedIn();
      allow read: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();

      // ë©”ì‹œì§€ ì„œë¸Œì»¬ë ‰ì…˜
      match /messages/{messageId} {
        allow create: if isSignedIn();
        allow read: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }

    // ========================================
    // ê·¸ë£¹ ì±„íŒ…ë°© (Group Chats)
    // ========================================
    match /groupChats/{groupId} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
      allow create: if isSignedIn();
      // ì½ê¸°: ë©¤ë²„ë§Œ
      allow read: if isSignedIn();
      // ìˆ˜ì •: ë©¤ë²„ë§Œ
      allow update: if isSignedIn();
      // ì‚­ì œ: ìƒì„±ìë§Œ
      allow delete: if isSignedIn();

      // ë©”ì‹œì§€ ì„œë¸Œì»¬ë ‰ì…˜
      match /messages/{messageId} {
        allow create: if isSignedIn();
        allow read: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }

    // ========================================
    // ì±„íŒ…ë°© (Chat Rooms) - ê³µìœ  ë¬¸ì„œ ê¸°ëŠ¥
    // ========================================
    match /chatRooms/{roomId} {
      // ì½ê¸°/ì“°ê¸°: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
      allow read, write: if isSignedIn();

      // ê³µìœ  ë¬¸ì„œ ì„œë¸Œì»¬ë ‰ì…˜
      match /sharedDocument/{docId} {
        allow read, write: if isSignedIn();

        // í¸ì§‘ ì´ë ¥ ì„œë¸Œì»¬ë ‰ì…˜
        match /editHistory/{editId} {
          allow read, write: if isSignedIn();
        }
      }

      // ë¬¸ì„œë³„ í¸ì§‘ ì´ë ¥ ì»¬ë ‰ì…˜ (ìƒˆ êµ¬ì¡°)
      match /documents/{memoId} {
        allow read, write: if isSignedIn();

        // í¸ì§‘ ì´ë ¥ ì„œë¸Œì»¬ë ‰ì…˜
        match /editHistory/{editId} {
          allow read, write: if isSignedIn();

          // ë§ˆì»¤ ì˜ê²¬ ì œì‹œ (ëŒ“ê¸€) - ê°„ë‹¨í•œ í•œì¤„ ê²Œì‹œíŒ í˜•íƒœ
          match /comments/{commentId} {
            // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìëŠ” ëª¨ë‘ ì½ê¸° ê°€ëŠ¥
            allow read: if isSignedIn();

            // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìëŠ” ëŒ“ê¸€ ì‘ì„± ê°€ëŠ¥
            allow create: if isSignedIn() &&
              request.resource.data.userId == request.auth.uid;

            // ë³¸ì¸ì´ ì‘ì„±í•œ ëŒ“ê¸€ë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥
            allow update, delete: if isSignedIn() &&
              resource.data.userId == request.auth.uid;
          }
        }
      }
    }

    // ========================================
    // CollectionGroup ì¿¼ë¦¬ë¥¼ ìœ„í•œ ê·œì¹™
    // ========================================
    // editHistory collectionGroup ì½ê¸° í—ˆìš© (ëª¨ë“  ëŒ€í™”ë°©ì˜ í¸ì§‘ ì´ë ¥ ê²€ìƒ‰ìš©)
    match /{path=**}/editHistory/{editId} {
      allow read: if isSignedIn();
    }

    // ========================================
    // ë‹‰ë„¤ì„ (Nicknames)
    // ========================================
    match /nicknames/{userId} {
      // ì½ê¸°: ëª¨ë“  ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬ìš©)
      allow read: if isSignedIn();
      // ìƒì„±/ìˆ˜ì •: ë³¸ì¸ë§Œ (userIdê°€ ë¬¸ì„œ IDì™€ ì¼ì¹˜)
      allow create, update: if isSignedIn() &&
        request.auth.uid == userId &&
        request.resource.data.userId == userId;
      // ì‚­ì œ: ë³¸ì¸ë§Œ
      allow delete: if isSignedIn() &&
        request.auth.uid == userId;
    }

    // ========================================
    // ë³¸ì¸ì¸ì¦ (Verifications)
    // ========================================
    match /verifications/{userId} {
      // ì½ê¸°: ëª¨ë“  ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (ì¸ì¦ ë±ƒì§€ í‘œì‹œìš©)
      allow read: if isSignedIn();
      // ìƒì„±/ìˆ˜ì •: ë³¸ì¸ë§Œ (userIdê°€ ë¬¸ì„œ IDì™€ ì¼ì¹˜)
      allow create, update: if isSignedIn() &&
        request.auth.uid == userId &&
        request.resource.data.userId == userId;
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ (ì¶”í›„ êµ¬í˜„)
      allow delete: if false;
    }

    // ========================================
    // ë©”ëª¨ (Memos)
    // ========================================
    match /memos/{memoId} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (ë³¸ì¸ì˜ ë©”ëª¨ë§Œ)
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;

      // ì½ê¸°: ë³¸ì¸ì˜ ë©”ëª¨ ë˜ëŠ” ê³µìœ  í´ë”ì˜ ë©”ëª¨
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        resource.data.folderId == 'shared'
      );

      // ìˆ˜ì •: ë³¸ì¸ì˜ ë©”ëª¨ ë˜ëŠ” ê³µìœ  í´ë”ì˜ ë©”ëª¨ (í˜‘ì—…ìš©)
      allow update: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        resource.data.folderId == 'shared'
      );

      // ì‚­ì œ: ë³¸ì¸ì˜ ë©”ëª¨ë§Œ
      allow delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
    }

    // ========================================
    // ì‚¬ìš©ì ë°ì´í„° (User Data) - ìƒˆë¡œ ì¶”ê°€
    // ========================================
    match /users/{userId}/userData/{dataType} {
      // ì½ê¸°/ì“°ê¸°: ë³¸ì¸ë§Œ
      allow read, write: if isSignedIn() && isOwner(userId);
    }

    // ========================================
    // ğŸ” íœ´ëŒ€í° ê¸°ë°˜ ì¸ì¦ êµ¬ì¡°
    // ========================================

    // MindFlow ì‚¬ìš©ì ê³„ì • (Primary ID: íœ´ëŒ€í° ë²ˆí˜¸ ë˜ëŠ” Firebase UID)
    match /mindflowUsers/{userId} {
      // âš ï¸ userIdëŠ” phoneNumber ë˜ëŠ” firebaseUID
      // Progressive Onboarding: êµ¬ê¸€ ë¡œê·¸ì¸ë§Œ í•˜ë©´ firebaseUID, íœ´ëŒ€í° ì¸ì¦í•˜ë©´ phoneNumber

      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ
      allow create: if isSignedIn();

      // ì½ê¸°: ë³¸ì¸ë§Œ (userIdê°€ firebaseUIDì´ê±°ë‚˜ ì—°ê²°ëœ ê³„ì •)
      allow read: if isSignedIn() && (
        // userIdê°€ ë³¸ì¸ì˜ Firebase UIDì¸ ê²½ìš° (êµ¬ê¸€ ë¡œê·¸ì¸ë§Œ)
        request.auth.uid == userId ||
        // ë˜ëŠ” ì—°ê²°ëœ ê³„ì •ì¸ ê²½ìš° (íœ´ëŒ€í° ì¸ì¦ ì™„ë£Œ)
        (resource.data.keys().hasAll(['loginMethods']) &&
         request.auth.uid in get(/databases/$(database)/documents/firebaseUIDToPhone/$(request.auth.uid)).data.keys())
      );

      // ìˆ˜ì •: ë³¸ì¸ë§Œ
      allow update: if isSignedIn() && (
        request.auth.uid == userId ||
        (resource.data.keys().hasAll(['loginMethods']) &&
         request.auth.uid in get(/databases/$(database)/documents/firebaseUIDToPhone/$(request.auth.uid)).data.keys())
      );

      // ì‚­ì œ: ë³¸ì¸ë§Œ
      allow delete: if isSignedIn() && (
        request.auth.uid == userId ||
        (resource.data.keys().hasAll(['loginMethods']) &&
         request.auth.uid in get(/databases/$(database)/documents/firebaseUIDToPhone/$(request.auth.uid)).data.keys())
      );

      // ì‚¬ìš©ì ë°ì´í„° ì„œë¸Œì»¬ë ‰ì…˜ (ê¸°ì¡´ ë°°ì—´ êµ¬ì¡° - í•˜ìœ„ í˜¸í™˜)
      match /userData/{dataType} {
        // settings ë¬¸ì„œ: ëª¨ë‘ ì½ê¸° ê°€ëŠ¥ (ë‹‰ë„¤ì„, í”„ë¡œí•„ ì‚¬ì§„ ê³µê°œ), ë³¸ì¸ë§Œ ì“°ê¸°
        allow read: if isSignedIn() && dataType == 'settings';
        // ë‹¤ë¥¸ ë¬¸ì„œ: ë³¸ì¸ë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
        allow read, write: if isSignedIn() && (
          request.auth.uid == userId
        );
      }

      // ğŸš€ ê°œë³„ ë©”ëª¨ ì»¬ë ‰ì…˜ (ìƒˆ êµ¬ì¡°)
      match /memos/{memoId} {
        // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ê³µìœ  í´ë” ë©”ëª¨
        allow read: if isSignedIn() && (
          request.auth.uid == userId ||
          resource.data.folderId == 'shared'
        );
        // ìˆ˜ì •: ë³¸ì¸ ë˜ëŠ” ê³µìœ  í´ë” ë©”ëª¨ (currentWorkingRoomId í”Œë˜ê·¸ ì—…ë°ì´íŠ¸ìš©)
        allow update: if isSignedIn() && (
          request.auth.uid == userId ||
          resource.data.folderId == 'shared'
        );
        // ìƒì„±/ì‚­ì œ: ë³¸ì¸ë§Œ
        allow create, delete: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸš€ ê°œë³„ í´ë” ì»¬ë ‰ì…˜ (ìƒˆ êµ¬ì¡°)
      match /folders/{folderId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸš€ ê°œë³„ íœ´ì§€í†µ ì»¬ë ‰ì…˜ (ìƒˆ êµ¬ì¡°)
      match /trash/{trashId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸš€ ê°œë³„ ë§¤í¬ë¡œ ì»¬ë ‰ì…˜ (ìƒˆ êµ¬ì¡°)
      match /macros/{macroId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸš€ ê°œë³„ ìº˜ë¦°ë” ì»¬ë ‰ì…˜ (ìƒˆ êµ¬ì¡°)
      match /calendar/{dateKey} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸš€ ê°œë³„ í™œë™ ì»¬ë ‰ì…˜ (ìƒˆ êµ¬ì¡°)
      match /activities/{activityId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸš€ ê°œë³„ ì‹œí¬ë¦¿ ë¬¸ì„œ ì»¬ë ‰ì…˜ (ê°œë³„ ë¬¸ì„œ ì•”í˜¸í™”)
      match /secretDocs/{docId} {
        // ë³¸ì¸ë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
        allow read, write: if isSignedIn() && (
          request.auth.uid == userId
        );
      }
    }

    // íœ´ëŒ€í° ë²ˆí˜¸ -> ì‚¬ìš©ì ID ë§¤í•‘
    match /phoneToUser/{phoneNumber} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ
      allow create: if isSignedIn();
      // ì½ê¸°: ëª¨ë“  ë¡œê·¸ì¸ ì‚¬ìš©ì (ê³„ì • ì¡°íšŒìš©)
      allow read: if isSignedIn();
      // ìˆ˜ì •/ì‚­ì œ: ê¸ˆì§€ (ë¶ˆë³€ ë°ì´í„°)
      allow update, delete: if false;
    }

    // Firebase UID -> íœ´ëŒ€í° ë²ˆí˜¸ ë§¤í•‘
    match /firebaseUIDToPhone/{firebaseUID} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ (ë³¸ì¸ì˜ UID)
      allow create: if isSignedIn() && firebaseUID == request.auth.uid;
      // ì½ê¸°: ë³¸ì¸ë§Œ
      allow read: if isSignedIn() && firebaseUID == request.auth.uid;
      // ìˆ˜ì •: ë³¸ì¸ë§Œ (ë¡œê·¸ì¸ ë°©ë²• ì¶”ê°€ ì‹œ)
      allow update: if isSignedIn() && firebaseUID == request.auth.uid;
      // ì‚­ì œ: ë³¸ì¸ë§Œ
      allow delete: if isSignedIn() && firebaseUID == request.auth.uid;
    }

    // ========================================
    // ì‹œìŠ¤í…œ ì„¤ì • (System Config) - ê´€ë¦¬ì ì„¤ì •
    // ========================================
    match /systemConfig/adminSettings {
      // âš ï¸ ì½ê¸°: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (ê´€ë¦¬ì í™•ì¸ìš©)
      // ì£¼ì˜: ë¯¼ê°í•œ ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ë¡œê·¸ ì¶œë ¥ ê¸ˆì§€
      allow read: if isSignedIn();

      // ğŸ” ì“°ê¸°: ìµœê³  ê´€ë¦¬ìë§Œ ê°€ëŠ¥ (ë¶€ê´€ë¦¬ì ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ)
      // ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ëˆ„êµ¬ë‚˜ ìƒì„± ê°€ëŠ¥ (ì´ˆê¸° ì„¤ì •)
      allow create: if isSignedIn();

      // ìˆ˜ì •/ì‚­ì œ: ìµœê³  ê´€ë¦¬ì ë˜ëŠ” ë¬¸ì„œë¥¼ ë®ì–´ì“°ëŠ” ê²½ìš° (ì´ˆê¸° ì„¤ì • ë³µêµ¬)
      allow update, delete: if isSignedIn() && (
        request.auth.uid == resource.data.superAdmin ||
        request.auth.uid == request.resource.data.superAdmin
      );
    }

    // ë‹¤ë¥¸ ì‹œìŠ¤í…œ ì„¤ì •ì€ ì½ê¸°ë§Œ ê°€ëŠ¥
    match /systemConfig/{configId} {
      allow read: if isSignedIn();
      allow write: if false;
    }

    // ========================================
    // ì‚¬ìš©ì ë¬¸ì˜ (User Inquiries) - 1:1 ë¬¸ì˜ ì‹œìŠ¤í…œ
    // ========================================
    match /userInquiries/{userId} {
      // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isSignedIn() && (
        request.auth.uid == userId ||
        isAdmin()
      );

      // ì“°ê¸°: ë³¸ì¸ë§Œ
      allow write: if isSignedIn() && request.auth.uid == userId;

      // ë¬¸ì˜ ì„œë¸Œì»¬ë ‰ì…˜
      match /inquiries/{inquiryId} {
        // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
        allow read: if isSignedIn() && (
          request.auth.uid == userId ||
          isAdmin()
        );

        // ìƒì„±: ë³¸ì¸ë§Œ (ì‚¬ìš©ìê°€ ë¬¸ì˜ ì‘ì„±)
        allow create: if isSignedIn() && request.auth.uid == userId;

        // ìˆ˜ì •: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì (ê´€ë¦¬ìëŠ” ìƒíƒœë§Œ ë³€ê²½ ê°€ëŠ¥)
        allow update: if isSignedIn() && (
          request.auth.uid == userId ||
          isAdmin()
        );

        // ì‚­ì œ: ë³¸ì¸ë§Œ ê°€ëŠ¥ (ë‹µë³€ ëŒ€ê¸° ì¤‘ì¸ ê²½ìš°ë§Œ)
        allow delete: if isSignedIn() && request.auth.uid == userId;

        // ë‹µë³€ ì„œë¸Œì»¬ë ‰ì…˜
        match /replies/{replyId} {
          // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
          allow read: if isSignedIn() && (
            request.auth.uid == userId ||
            isAdmin()
          );

          // ìƒì„±: reply ê¶Œí•œì´ ìˆëŠ” ê´€ë¦¬ìë§Œ
          allow create: if hasPermission('reply');

          // ìˆ˜ì •: edit ê¶Œí•œì´ ìˆëŠ” ê´€ë¦¬ìë§Œ
          allow update: if hasPermission('edit');

          // ì‚­ì œ: delete ê¶Œí•œì´ ìˆëŠ” ê´€ë¦¬ìë§Œ
          allow delete: if hasPermission('delete');
        }
      }
    }

    // ========================================
    // CollectionGroup ì¿¼ë¦¬: ëª¨ë“  ë¬¸ì˜ ì¡°íšŒ (ê´€ë¦¬ì ì „ìš©)
    // ========================================
    match /{path=**}/inquiries/{inquiryId} {
      // ê´€ë¦¬ìë§Œ ì¡°íšŒ ê°€ëŠ¥
      allow read: if isAdmin();
    }

    // ì‚¬ìš©ìë³„ ì•Œë¦¼ ì„œë¸Œì»¬ë ‰ì…˜
    match /users/{userId}/notifications/{notificationId} {
      // ì½ê¸°: ë³¸ì¸ë§Œ
      allow read: if isSignedIn() && request.auth.uid == userId;

      // ìƒì„±: ì‹œìŠ¤í…œ ë˜ëŠ” ê´€ë¦¬ì (ë¬¸ì˜ ì•Œë¦¼ìš©)
      allow create: if isSignedIn();

      // ìˆ˜ì •: ë³¸ì¸ë§Œ (ì½ìŒ ì²˜ë¦¬)
      allow update: if isSignedIn() && request.auth.uid == userId;

      // ì‚­ì œ: ë³¸ì¸ë§Œ
      allow delete: if isSignedIn() && request.auth.uid == userId;
    }
  }
}
