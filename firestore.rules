rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // í—¬í¼ í•¨ìˆ˜ë“¤
    // ========================================

    // ì‚¬ìš©ì ì¸ì¦ í™•ì¸
    function isSignedIn() {
      return request.auth != null;
    }

    // ì‚¬ìš©ì ID ì†Œìœ ê¶Œ í™•ì¸
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ========================================
    // ê¸°ì¡´ ë ˆìŠ¤í† ë‘/ë¦¬ë·° - ê³µê°œ ì½ê¸°
    // ========================================
    match /restaurants/{restaurantId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    match /reviews/{reviewId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    match /userProfiles/{userId} {
      allow read: if true;
      allow write: if isOwner(userId);
    }

    // ========================================
    // ì‚¬ìš©ì (Users) ì»¬ë ‰ì…˜
    // ========================================
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(userId);
      allow update, delete: if isOwner(userId);

      // ğŸ†• ì¹œêµ¬ ì„œë¸Œì»¬ë ‰ì…˜ - ë³¸ì¸ë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      match /friends/{friendId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
    }

    // ========================================
    // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ (Workspaces)
    // ========================================
    match /workspaces/{workspaceId} {
      // ìƒì„±: ë¡œê·¸ì¸ + ì†Œìœ ì í™•ì¸
      allow create: if isSignedIn() &&
        request.resource.data.ownerId == request.auth.uid;

      // ì½ê¸°: ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì (ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì½”ë“œë¡œ ì ‘ê·¼)
      allow read: if isSignedIn();

      // ìˆ˜ì •: ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì†Œìœ ìë§Œ
      allow update: if isSignedIn() &&
        request.auth.uid == resource.data.ownerId;

      // ì‚­ì œ: ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì†Œìœ ìë§Œ
      allow delete: if isSignedIn() &&
        request.auth.uid == resource.data.ownerId;
    }

    // ========================================
    // ë©”ëª¨ ê³µìœ  (Shared Memos)
    // ========================================
    match /sharedMemos/{memoId} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
      allow create: if isSignedIn();

      // ì½ê¸°: ì†Œìœ ì ë˜ëŠ” ê³µìœ ë°›ì€ ì‚¬ëŒ (í´ë¼ì´ì–¸íŠ¸ ê²€ì¦)
      allow read: if isSignedIn();

      // ìˆ˜ì •/ì‚­ì œ: ì†Œìœ ìë§Œ
      allow update, delete: if isSignedIn() &&
        request.auth.uid == resource.data.ownerId;
    }

    // ========================================
    // ì¹œêµ¬ ê´€ê³„ (Friendships)
    // ========================================
    match /friendships/{friendshipId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ========================================
    // ì¹œêµ¬ ìš”ì²­ (Friend Requests)
    // ========================================
    match /friendRequests/{requestId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ========================================
    // ê³µìœ  ë…¸íŠ¸ (Shared Notes)
    // ========================================
    match /sharedNotes/{noteId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn() &&
        resource.data.ownerId == request.auth.uid;
    }

    // ========================================
    // ìˆ˜ì • ì œì•ˆ (Edit Suggestions)
    // ========================================
    match /editSuggestions/{suggestionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ========================================
    // ì•Œë¦¼ (Notifications)
    // ========================================
    match /notifications/{notificationId} {
      allow read: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
      allow create: if isSignedIn();
      allow update: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
    }

    // ========================================
    // íƒ€ì´í•‘ ìƒíƒœ (Typing Status)
    // ========================================
    match /typingStatus/{statusId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
    }

    // ========================================
    // 1:1 ëŒ€í™”ë°© (Direct Messages)
    // ========================================
    match /directMessages/{roomId} {
      // í…ŒìŠ¤íŠ¸ìš© ë‹¨ìˆœ ê·œì¹™: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ
      allow create: if isSignedIn();
      allow read: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();

      // ë©”ì‹œì§€ ì„œë¸Œì»¬ë ‰ì…˜
      match /messages/{messageId} {
        allow create: if isSignedIn();
        allow read: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }

    // ========================================
    // ê·¸ë£¹ ì±„íŒ…ë°© (Group Chats)
    // ========================================
    match /groupChats/{groupId} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
      allow create: if isSignedIn();
      // ì½ê¸°: ë©¤ë²„ë§Œ
      allow read: if isSignedIn();
      // ìˆ˜ì •: ë©¤ë²„ë§Œ
      allow update: if isSignedIn();
      // ì‚­ì œ: ìƒì„±ìë§Œ
      allow delete: if isSignedIn();

      // ë©”ì‹œì§€ ì„œë¸Œì»¬ë ‰ì…˜
      match /messages/{messageId} {
        allow create: if isSignedIn();
        allow read: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }

    // ========================================
    // ë‹‰ë„¤ì„ (Nicknames)
    // ========================================
    match /nicknames/{userId} {
      // ì½ê¸°: ëª¨ë“  ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬ìš©)
      allow read: if isSignedIn();
      // ìƒì„±/ìˆ˜ì •: ë³¸ì¸ë§Œ (userIdê°€ ë¬¸ì„œ IDì™€ ì¼ì¹˜)
      allow create, update: if isSignedIn() &&
        request.auth.uid == userId &&
        request.resource.data.userId == userId;
      // ì‚­ì œ: ë³¸ì¸ë§Œ
      allow delete: if isSignedIn() &&
        request.auth.uid == userId;
    }

    // ========================================
    // ë³¸ì¸ì¸ì¦ (Verifications)
    // ========================================
    match /verifications/{userId} {
      // ì½ê¸°: ëª¨ë“  ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (ì¸ì¦ ë±ƒì§€ í‘œì‹œìš©)
      allow read: if isSignedIn();
      // ìƒì„±/ìˆ˜ì •: ë³¸ì¸ë§Œ (userIdê°€ ë¬¸ì„œ IDì™€ ì¼ì¹˜)
      allow create, update: if isSignedIn() &&
        request.auth.uid == userId &&
        request.resource.data.userId == userId;
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ (ì¶”í›„ êµ¬í˜„)
      allow delete: if false;
    }

    // ========================================
    // ë©”ëª¨ (Memos)
    // ========================================
    match /memos/{memoId} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (ë³¸ì¸ì˜ ë©”ëª¨ë§Œ)
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;

      // ì½ê¸°: ë³¸ì¸ì˜ ë©”ëª¨ë§Œ
      allow read: if isSignedIn() &&
        resource.data.userId == request.auth.uid;

      // ìˆ˜ì •: ë³¸ì¸ì˜ ë©”ëª¨ë§Œ
      allow update: if isSignedIn() &&
        resource.data.userId == request.auth.uid;

      // ì‚­ì œ: ë³¸ì¸ì˜ ë©”ëª¨ë§Œ
      allow delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
    }

    // ========================================
    // ì‚¬ìš©ì ë°ì´í„° (User Data) - ìƒˆë¡œ ì¶”ê°€
    // ========================================
    match /users/{userId}/userData/{dataType} {
      // ì½ê¸°/ì“°ê¸°: ë³¸ì¸ë§Œ
      allow read, write: if isSignedIn() && isOwner(userId);
    }

    // ========================================
    // ğŸ” íœ´ëŒ€í° ê¸°ë°˜ ì¸ì¦ êµ¬ì¡°
    // ========================================

    // MindFlow ì‚¬ìš©ì ê³„ì • (Primary ID: íœ´ëŒ€í° ë²ˆí˜¸ ë˜ëŠ” Firebase UID)
    match /mindflowUsers/{userId} {
      // âš ï¸ userIdëŠ” phoneNumber ë˜ëŠ” firebaseUID
      // Progressive Onboarding: êµ¬ê¸€ ë¡œê·¸ì¸ë§Œ í•˜ë©´ firebaseUID, íœ´ëŒ€í° ì¸ì¦í•˜ë©´ phoneNumber

      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ
      allow create: if isSignedIn();

      // ì½ê¸°: ë³¸ì¸ë§Œ (userIdê°€ firebaseUIDì´ê±°ë‚˜ ì—°ê²°ëœ ê³„ì •)
      allow read: if isSignedIn() && (
        // userIdê°€ ë³¸ì¸ì˜ Firebase UIDì¸ ê²½ìš° (êµ¬ê¸€ ë¡œê·¸ì¸ë§Œ)
        request.auth.uid == userId ||
        // ë˜ëŠ” ì—°ê²°ëœ ê³„ì •ì¸ ê²½ìš° (íœ´ëŒ€í° ì¸ì¦ ì™„ë£Œ)
        (resource.data.keys().hasAll(['loginMethods']) &&
         request.auth.uid in get(/databases/$(database)/documents/firebaseUIDToPhone/$(request.auth.uid)).data.keys())
      );

      // ìˆ˜ì •: ë³¸ì¸ë§Œ
      allow update: if isSignedIn() && (
        request.auth.uid == userId ||
        (resource.data.keys().hasAll(['loginMethods']) &&
         request.auth.uid in get(/databases/$(database)/documents/firebaseUIDToPhone/$(request.auth.uid)).data.keys())
      );

      // ì‚­ì œ: ë³¸ì¸ë§Œ
      allow delete: if isSignedIn() && (
        request.auth.uid == userId ||
        (resource.data.keys().hasAll(['loginMethods']) &&
         request.auth.uid in get(/databases/$(database)/documents/firebaseUIDToPhone/$(request.auth.uid)).data.keys())
      );

      // ì‚¬ìš©ì ë°ì´í„° ì„œë¸Œì»¬ë ‰ì…˜ (ê¸°ì¡´ ë°°ì—´ êµ¬ì¡° - í•˜ìœ„ í˜¸í™˜)
      match /userData/{dataType} {
        // ë³¸ì¸ë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
        allow read, write: if isSignedIn() && (
          request.auth.uid == userId
        );
      }

      // ğŸš€ ê°œë³„ ë©”ëª¨ ì»¬ë ‰ì…˜ (ìƒˆ êµ¬ì¡°)
      match /memos/{memoId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸš€ ê°œë³„ í´ë” ì»¬ë ‰ì…˜ (ìƒˆ êµ¬ì¡°)
      match /folders/{folderId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸš€ ê°œë³„ íœ´ì§€í†µ ì»¬ë ‰ì…˜ (ìƒˆ êµ¬ì¡°)
      match /trash/{trashId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸš€ ê°œë³„ ë§¤í¬ë¡œ ì»¬ë ‰ì…˜ (ìƒˆ êµ¬ì¡°)
      match /macros/{macroId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸš€ ê°œë³„ ìº˜ë¦°ë” ì»¬ë ‰ì…˜ (ìƒˆ êµ¬ì¡°)
      match /calendar/{dateKey} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸš€ ê°œë³„ í™œë™ ì»¬ë ‰ì…˜ (ìƒˆ êµ¬ì¡°)
      match /activities/{activityId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      // ğŸš€ ê°œë³„ ì‹œí¬ë¦¿ ë¬¸ì„œ ì»¬ë ‰ì…˜ (ê°œë³„ ë¬¸ì„œ ì•”í˜¸í™”)
      match /secretDocs/{docId} {
        // ë³¸ì¸ë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
        allow read, write: if isSignedIn() && (
          request.auth.uid == userId
        );
      }
    }

    // íœ´ëŒ€í° ë²ˆí˜¸ -> ì‚¬ìš©ì ID ë§¤í•‘
    match /phoneToUser/{phoneNumber} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ
      allow create: if isSignedIn();
      // ì½ê¸°: ëª¨ë“  ë¡œê·¸ì¸ ì‚¬ìš©ì (ê³„ì • ì¡°íšŒìš©)
      allow read: if isSignedIn();
      // ìˆ˜ì •/ì‚­ì œ: ê¸ˆì§€ (ë¶ˆë³€ ë°ì´í„°)
      allow update, delete: if false;
    }

    // Firebase UID -> íœ´ëŒ€í° ë²ˆí˜¸ ë§¤í•‘
    match /firebaseUIDToPhone/{firebaseUID} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ (ë³¸ì¸ì˜ UID)
      allow create: if isSignedIn() && firebaseUID == request.auth.uid;
      // ì½ê¸°: ë³¸ì¸ë§Œ
      allow read: if isSignedIn() && firebaseUID == request.auth.uid;
      // ìˆ˜ì •: ë³¸ì¸ë§Œ (ë¡œê·¸ì¸ ë°©ë²• ì¶”ê°€ ì‹œ)
      allow update: if isSignedIn() && firebaseUID == request.auth.uid;
      // ì‚­ì œ: ë³¸ì¸ë§Œ
      allow delete: if isSignedIn() && firebaseUID == request.auth.uid;
    }
  }
}
